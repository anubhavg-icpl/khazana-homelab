- name: Configure reverse proxy
  hosts: reverse_proxy
  vars:
    reverse_proxy_user: reverse-proxy
    reverse_proxy_network: reverse-proxy
    reverse_proxy_network_subnet: '10.89.0.5/24'
    reverse_proxy_network_gateway: '10.89.0.1'
  tasks:

    - name: Ensure there's a virtual network for reverse-proxy
      ansible.builtin.import_role:
        name: podman
        tasks_from: network
      vars:
        podman_network: '{{ reverse_proxy_network }}'
        podman_network_subnet: '{{ reverse_proxy_network_subnet }}'
        podman_network_gateway: '{{ reverse_proxy_network_gateway }}'
        podman_user: '{{ reverse_proxy_user }}'

    - name: Deploy Caddy
      ansible.builtin.import_role:
        name: caddy
      vars:
        caddy_user: "{{ reverse_proxy_user }}"
        caddy_container: caddy
        caddy_opt: caddy_opt
        caddy_tls: caddy_tls
        caddy_conf: /etc/Caddyfile
        caddy_internet_facing: false
        caddy_networks: '{{ reverse_proxy_network }}'
        caddy_ip: '10.89.0.10'
        caddy_image: 'caddy-private'
        caddy_extensions:
          - github.com/caddy-dns/cloudflare
          - github.com/corazawaf/coraza-caddy/v2
        caddy_cloudflare_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30383031646136366238343335666164363934646564663434643131323861336362616238303735
          3730356635333337623830353965653831616362646634660a666230376330633166653937386664
          33363938383431333364386663663465303730333261386531666635306135373732303263313437
          6562353139353534390a656563373730616431316638363439363364333465623336396336626232
          38356164656137626662653435363739366136646266653164303433313739636166373338613866
          3166643262633138316233396335343337333530346631613134

    - name: Deploy Tailscale private reverse proxy client
      ansible.builtin.import_role:
        name: tailscale_client
      vars:
        tailscale_client_user: '{{ reverse_proxy_user }}'
        tailscale_client_container: 'tailscale_client_private_reverse_proxy'
        tailscale_client_networks: '{{ reverse_proxy_network }}'
        tailscale_client_state_vol: 'tailscale_client_private_reverse_proxy_state'
        tailscale_client_accept_dns: 'false'
        tailscale_client_authkey: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          33646531653433303136626133343035333932633830623533346361316463383365353636666334
          6330643233643132333737646161323935363962353163310a663165356362383434363263376263
          34663863353163373734313863373739353733333035383231363238306631653532623731323731
          6232623037353865320a333163663238653137393666653737366138313064326365303533653136
          33633765323438323266393934323037326265373937336336636530343561376136363164383533
          36316134396364346231366662356236653962353432356339343830633564666363373231666535
          616237323432363231323037353439613031
        tailscale_client_hostname: 'private-reverse-proxy'
        # tailscale_client_dest_ip: '{{ vps_adblock_ip }}'
        tailscale_client_userspace: 'false'

    - name: Deploy Wazuh agent
      ansible.builtin.import_role:
        name: wazuh_agent
      vars:
        wazuh_agent_version: '4.x'
        wazuh_agent_manager_host: '{{ siem_host }}'
        wazuh_agent_registration_pass: '{{ siem_enrollment_pass }}'
        wazuh_agent_name: 'reverse_proxy'
        wazuh_agent_groups: 'internet_facing,trusted'
