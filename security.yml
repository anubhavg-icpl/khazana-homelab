- name: Configure security virtual machine
  hosts: security
  vars:
    security_user: security
    security_network: security
    podman_user: "{{ security_user }}"
    security_keycloak_pg_pass: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      34623238643730623933356136663966326437333764343138313661383733393837326336376162
      3165623636366538653037343839313835376138616336620a353638633138643535316664626232
      33653234373836303139346238643336653139646663626636613766636465313463666536313730
      3266623763376635370a386135663562613737663431336464663666363839356235633939626330
      6561
    security_vaultwarden_data: /var/vaultwarden

  tasks:
    - name: Ensure there's a virtual network for Keycloak
      ansible.builtin.import_role:
        name: podman
        tasks_from: network
      vars:
        podman_network: "{{ security_network }}"

    - name: Ensure there's a directory to store Keycloak PGData
      ansible.builtin.import_role:
        name: podman
        tasks_from: local_volume
      vars:
        podman_local_volume: /var/postgres

    - name: Deploy Postgres for Keycloak
      ansible.builtin.import_role:
        name: postgres
      vars:
        postgres_podman_user: "{{ security_user }}"
        postgres_container: postgres
        postgres_data: "/var/postgres"
        postgres_db: keycloak
        postgres_user: keycloak
        postgres_network: "{{ security_network }}"
        postgres_pass: "{{ security_keycloak_pg_pass }}"

    - name: Deploy Keycloak
      ansible.builtin.import_role:
        name: keycloak
      vars:
        keycloak_user: "{{ security_user }}"
        keycloak_container: keycloak
        keycloak_pg_pass: "{{ security_keycloak_pg_pass }}"
        keycloak_bootstrap_username: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32313338643134653734343765353531313665386464363634303166613939316163663262616631
          3430303639346139353937663634633363346564336133350a363230366465366131313030323332
          30623264353332326336626235353334643135633865333731396535663039633033366633303035
          3234643564646638350a393138363061633665623037386135376638306464343665656433666139
          3961
        keycloak_bootstrap_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          61663861396437333062623335393436303136343566396262643962333061663936653737353038
          3337306436613936636136623930303062343534323165630a393138333238363235313734373066
          31373739653334326161386463643366653639643966663366313961393832623066313737656436
          6138393066373534640a343035653961353438343030336233316562363234353363326539633231
          6237

    - name: Ensure there's a directory to store Vaultwarden data
      ansible.builtin.import_role:
        name: podman
        tasks_from: local_volume
      vars:
        podman_local_volume: "{{ security_vaultwarden_data }}"

    - name: Deploy Vaultwarden
      ansible.builtin.import_role:
        name: vaultwarden
      vars:
        vaultwarden_container: vaultwarden
        vaultwarden_user: "{{ security_user }}"
        vaultwarden_data: "{{ security_vaultwarden_data }}"
        vaultwarden_admin_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          62333933613636626334633735643234373361643037303733353264663733363234396261343332
          6333656663366337663236633437303832643165303361330a356163613365633131363662323235
          33373233656437303835306231623065613133363263323334643839363161633030333034376563
          3830386264633761310a653065356265356334343831336132343366333932646534326663376235
          36656634623663356266343131666236666638383865373366323266623237366363356431336233
          36616664613965386563623064663030636137363365666139353036383134656639383136623835
          31363662613932623136646332383738663433376634363637333533333466383538323832613638
          35656232303366366331
        vaultwarden_signups_allowed: false
        vaultwarden_host: "{{ password_mgr_host }}"
