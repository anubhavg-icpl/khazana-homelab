- name: Configure Code virtual machine
  hosts: code
  vars:
    code_user: code
    code_network: code
  tasks:
    - name: Ensure there's a virtual network for code
      ansible.builtin.import_role:
        name: podman
        tasks_from: network
      vars:
        podman_network: "{{ code_network }}"
        podman_user: "{{ code_user }}"

    - name: Deploy code_server
      ansible.builtin.import_role:
        name: code_server
      vars:
        code_server_user: "{{ code_user }}"
        code_server_container: code-server
        code_server_image: code-server
        code_server_network: "{{ code_network }}"
        code_server_port: "8443"
        code_server_sudo_pass: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          34633465323133663336383031356331373066303537366233323033366562656263623137613532
          3031346534366231386461333834653330623962646262370a343265333163363236666636663134
          37376637613962626263326430313733346536303730383032366263653765633836383334303131
          3439306135316638320a336335303631633065373636616531633865323131313738633366633664
          3434
        code_server_proxy_domain: "{{ code_host }}"
        code_server_workspace: code_server_workspace
        code_server_extra_pkgs:
          - git
          - curl
          - wget
          - ansible
          - ansible-lint

    - name: Deploy oauth2_proxy
      ansible.builtin.import_role:
        name: oauth2_proxy
      vars:
        oauth2_proxy_user: "{{ code_user }}"
        oauth2_proxy_container: "oauth2-proxy"
        oauth2_proxy_port: "4180"
        oauth2_proxy_network: "{{ code_network }}"
        oauth2_proxy_http_address: "0.0.0.0:4180"
        oauth2_proxy_email_domains: '["*"]'
        oauth2_proxy_reverse: "true"
        oauth2_proxy_cookie_secret: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          38663139346433363432623437636534366163633561313734316635313230323562323064373533
          6432396232366262343336666430636236623337343336370a633635653966393464393565343666
          31316230613438643233303133613164366366393966313966616135386535633362396335633665
          6236663663383732630a613466393661373663653862323138353737376432643764326264393037
          63393534643034346333373135356263383736653837383838323663666138633362343134643062
          3362373062366138636332383361333733623262343439396634
        oauth2_proxy_whitelist_domains: '[".{{ internet_host }}"]'
        oauth2_proxy_cookie_domains: '[".{{ internet_host }}"]'
        oauth2_proxy_provider: "{{ homelab_oidc_provider }}"
        oauth2_proxy_client_id: "{{ code_client }}"
        oauth2_proxy_client_secret: "{{ code_secret }}"
        oauth2_proxy_redirect_url: "https://{{ code_host }}.{{ internet_host }}/oauth2/callback"
        oauth2_proxy_oidc_url: "https://{{ auth_host }}.{{ internet_host }}/realms/{{ homelab_realm }}"
        oauth2_proxy_allow_unverified_email: "true"
